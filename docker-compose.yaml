services:
  # Main watcher application
  watcher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: watcher-app
    ports:
      - "8080:8080"  # Metrics
    environment:
      - BASE_RPC_URL=${BASE_RPC_URL}
      - BASE_WS_URL=${BASE_WS_URL}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CURATOR_TOP_POOLS_COUNT=${CURATOR_TOP_POOLS_COUNT}
      - DETECTOR_MAX_PATH_LENGTH=${DETECTOR_MAX_PATH_LENGTH}
      - SQLITE_PATH=/app/data/watcher.db
    volumes:
      - watcher_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Neo4j is kept for future analytical use but not used in the hot path
  neo4j:
    image: neo4j:2025.09.0-community
    container_name: watcher-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/your-secure-password
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_PLUGINS=["apoc","graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=gds.*,apoc.*
      - NEO4J_dbms_security_procedures_allowlist=gds.*,apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    profiles:
      - analytics

volumes:
  watcher_data:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
